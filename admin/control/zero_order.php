<?php/** * 0元淘订单管理 * * **/defined('InSystem') or exit('Access Invalid!');class zero_orderControl extends SystemControl{	public function __construct(){		parent::__construct();	}	/**	 * 订单列表	 */	public function indexOp(){            $model_zero_order = Model('zero_order');            $model_express = Model('express');            $shipping_list = $model_express->getAllList('','id,e_name');            /**             * 检索条件             */            $condition = array();            if (!empty($_GET['order_sn'])){                $condition['zero_order.order_sn'] = array('eq',$_GET['order_sn']);            }            if (is_numeric($_GET['order_state'])){                $condition['zero_order.order_state'] = array('eq',$_GET['order_state']);            }            if (!empty($_GET['buyer_name'])){                $condition['zero_order.buyer_name'] = array('eq',$_GET['buyer_name']);            }            $list = $model_zero_order->getAdminOrderList($condition,'*','','zero_order.order_state ASC,zero_order.add_time DESC', 0, 10,0);//            dump($list);die;            Tpl::output('page',$model_zero_order->showpage());            Tpl::output('list',$list);            Tpl::output('shipping_list',$shipping_list);            Tpl::output('order_sn',trim($_GET['order_sn']));            Tpl::output('order_state',trim($_GET['order_state']));            Tpl::output('buyer_name',trim($_GET['buyer_name']));            Tpl::showpage('zero_order.index');	}    /**     * 发货     */	public function shipping_goodsOp(){        $model_zero_order = Model('zero_order');        $model_express = Model('express');        $info = $model_zero_order->getInfo(array('order_id' => intval($_GET['order_id'])));        $shipping_list = $model_express->getAllList('','id,e_name');//                dump($info);        if (chksubmit()){            $obj_validate = new Validate();            $obj_validate->validateparam = array(                array("input"=>$_POST["shipping_code"], "require"=>"true", "message"=>'物流单号不能为空!'),                array("input"=>$_POST["shipping_express_id"], "require"=>"true", "message"=>'配送公司不能为空!'),            );            $error = $obj_validate->validate();            if ($error != ''){                showMessage($error);            }else {                $where = array();                $where['order_id'] = trim($_POST['order_id']);                $update_array = array();                $update_array['order_state'] = 30;                $update_array['shipping_code'] = trim($_POST['shipping_code']);                $update_array['shipping_express_id'] = trim($_POST['shipping_express_id']);                $update_array['shipping_time'] = time();                $result = $model_zero_order->editData($update_array, $where);                if ($result){                    $url = array(                        array(                            'url'=>'index.php?act=zero_order&op=shipping_goods&order_id='.trim($_POST['order_id']),                            'msg'=>'继续发货',                        ),                        array(                            'url'=>'index.php?act=zero_order&op=index',                            'msg'=>'返回订单列表',                        )                    );                    $this->log('发货['.$_POST['goods_name'].']',1);                    showMessage('保存成功',$url);                }else {                    $this->log('编辑['.$_POST['goods_name'].']',0);                    showMessage('保存失败');                }            }        }        if (empty($info)){            showMessage('参数错误');        }        Tpl::output('info',$info);        Tpl::output('shipping_list',$shipping_list);        Tpl::showpage('zero_order.shipping');    }}